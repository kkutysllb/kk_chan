# 多趋势共振策略

## 策略概述

多趋势共振策略是一个基于多时间周期技术分析的量化策略，专注于捕捉不同时间维度趋势的共振信号。该策略通过分析日线、周线、月线的技术指标，识别多重趋势方向一致的股票，实现高胜率的投资收益。

## 策略特色

### 🎯 核心理念
- **多维共振**：结合日线、周线、月线多时间周期分析
- **技术驱动**：基于MACD、KDJ、成交量等多重技术指标
- **趋势跟踪**：捕捉强势趋势的延续性机会
- **风险控制**：严格的止损止盈和共振信号管理

### 📊 策略表现
- **选股来源**：中证A500成分股
- **信号类型**：多趋势共振买卖信号
- **持仓周期**：中短期持仓（1-3个月）
- **风险等级**：中等风险，追求稳健收益

## 策略逻辑

### 🔍 股票池构建
```python
# 1. 基础股票池：中证A500成分股
def get_csi_a500_components():
    # 从index_weight集合查询中证A500成分股
    index_query = {'index_code': '000510.CSI'}
    index_data = db.find_data('index_weight', index_query)
    
    # 提取所有成分股代码
    csi_a500_codes = []
    for record in index_data:
        if 'con_code' in record:
            csi_a500_codes.append(record['con_code'])
    
    return list(set(csi_a500_codes))  # 去重

# 2. 动态筛选：选择技术面强势的股票
selected_stocks = filter_by_technical_strength(csi_a500_codes, max_count=50)

# 3. 质量过滤
filtered_stocks = filter_stocks(selected_stocks, {
    'exclude_st': True,        # 排除ST股票
    'exclude_suspended': True, # 排除停牌股票
    'exclude_limit': True,     # 排除涨跌停股票
    'min_volume': 5000000,     # 最小成交量要求
    'min_turnover': 0.01       # 最小换手率要求
})
```

### 📈 多趋势共振模型
```python
# 核心技术指标配置
TECHNICAL_CONFIG = {
    'macd_fast': 12,           # MACD快线周期
    'macd_slow': 26,           # MACD慢线周期
    'macd_signal': 9,          # MACD信号线周期
    'kdj_period': 9,           # KDJ指标周期
    'kdj_overbought': 80,      # KDJ超买线
    'kdj_oversold': 20,        # KDJ超卖线
    'volume_ma_period': 15,    # 成交量均线周期
    'volume_surge_threshold': 1.3,  # 成交量放大阈值
    'trend_strength_threshold': 0.3, # 趋势强度阈值
    'min_resonance_score': 6,  # 最小共振得分
    'strong_resonance_score': 9 # 强共振得分
}

# 多时间周期趋势分析
def analyze_multi_timeframe_trend(stock_data):
    """分析多时间周期趋势"""
    
    # 日线趋势分析
    daily_trend = analyze_daily_trend(stock_data)
    
    # 周线趋势分析（基于日线数据重采样）
    weekly_data = resample_to_weekly(stock_data)
    weekly_trend = analyze_weekly_trend(weekly_data)
    
    # 月线趋势分析（基于日线数据重采样）
    monthly_data = resample_to_monthly(stock_data)
    monthly_trend = analyze_monthly_trend(monthly_data)
    
    return {
        'daily': daily_trend,
        'weekly': weekly_trend,
        'monthly': monthly_trend
    }

# 共振得分计算
def calculate_resonance_score(stock_data):
    """计算多趋势共振得分"""
    score = 0
    
    # 1. MACD指标得分（0-3分）
    macd_score = calculate_macd_score(stock_data)
    score += macd_score
    
    # 2. KDJ指标得分（0-3分）
    kdj_score = calculate_kdj_score(stock_data)
    score += kdj_score
    
    # 3. 成交量指标得分（0-2分）
    volume_score = calculate_volume_score(stock_data)
    score += volume_score
    
    # 4. 趋势强度得分（0-2分）
    trend_score = calculate_trend_strength_score(stock_data)
    score += trend_score
    
    # 5. 价格位置得分（0-1分）
    price_score = calculate_price_position_score(stock_data)
    score += price_score
    
    return score  # 总分0-11分
```

### 🚀 买入信号
满足以下**所有条件**时产生买入信号：

1. **多趋势共振**：日线、周线、月线趋势方向一致向上
2. **技术指标共振**：MACD、KDJ等多个指标同时发出买入信号
3. **成交量配合**：成交量明显放大，确认资金流入
4. **共振得分达标**：综合得分≥6分（最小共振阈值）

```python
def check_buy_signal(stock_data, current_date):
    """检查买入信号"""
    
    # 1. 计算共振得分
    resonance_score = calculate_resonance_score(stock_data)
    
    # 2. 多时间周期趋势分析
    trends = analyze_multi_timeframe_trend(stock_data)
    
    # 3. 技术指标分析
    macd_signal = check_macd_bullish(stock_data)
    kdj_signal = check_kdj_golden_cross(stock_data)
    volume_surge = check_volume_surge(stock_data)
    
    # 4. 买入条件检查
    conditions = [
        resonance_score >= TECHNICAL_CONFIG['min_resonance_score'],  # 共振得分
        trends['daily'] == 'bullish',     # 日线多头
        trends['weekly'] == 'bullish',    # 周线多头
        macd_signal,                      # MACD金叉
        kdj_signal or check_kdj_oversold_rebound(stock_data),  # KDJ信号
        volume_surge,                     # 成交量放大
        not check_overbought_condition(stock_data)  # 非超买状态
    ]
    
    # 强共振信号（得分≥9）可以放宽部分条件
    if resonance_score >= TECHNICAL_CONFIG['strong_resonance_score']:
        strong_conditions = [
            resonance_score >= TECHNICAL_CONFIG['strong_resonance_score'],
            trends['daily'] == 'bullish',
            macd_signal or kdj_signal,
            volume_surge
        ]
        return all(strong_conditions), resonance_score
    
    return all(conditions), resonance_score
```

### 📉 卖出信号
满足以下**任一条件**时产生卖出信号：

1. **止损保护**：价格跌破-6%止损位
2. **止盈保护**：价格达到+12%止盈位
3. **共振信号转弱**：共振得分降至3分以下
4. **趋势破坏**：关键技术位破位或趋势反转

```python
def check_sell_signal(stock_data, entry_info, current_date):
    """检查卖出信号"""
    
    current_price = stock_data['close'].iloc[-1]
    entry_price = entry_info['entry_price']
    
    # 1. 止损止盈检查
    pnl_ratio = (current_price - entry_price) / entry_price
    
    if pnl_ratio <= -0.06:  # 6%止损
        return True, f"止损卖出: {pnl_ratio:.2%}"
    
    if pnl_ratio >= 0.12:  # 12%止盈
        return True, f"止盈卖出: {pnl_ratio:.2%}"
    
    # 2. 共振信号检查
    current_score = calculate_resonance_score(stock_data)
    if current_score < 3:
        return True, f"共振信号转弱: 得分{current_score}"
    
    # 3. 趋势破坏检查
    trends = analyze_multi_timeframe_trend(stock_data)
    if trends['daily'] == 'bearish' and trends['weekly'] == 'bearish':
        return True, "多时间周期趋势转空"
    
    # 4. 技术破位检查
    if check_technical_breakdown(stock_data):
        return True, "关键技术位破位"
    
    # 5. 盈利保护（盈利8%后，回撤4%卖出）
    if pnl_ratio > 0.08:
        recent_high = stock_data['close'][-10:].max()
        if current_price < recent_high * 0.96:
            return True, f"盈利回撤卖出: 从高点回撤{(1-current_price/recent_high):.2%}"
    
    return False, ""
```

## 风险管理

### 💰 资金管理
- **初始资金**：100万元
- **单股限额**：最大12万元（12%仓位）
- **总持仓数**：最多持有8只股票
- **动态调仓**：根据共振信号强度调整仓位

### 🛡️ 风险控制
- **止损机制**：单股-6%止损
- **止盈机制**：单股+12%止盈
- **仓位控制**：分散投资降低集中度风险
- **信号过滤**：严格的共振得分要求

### ⏰ 时间管理
- **信号频率**：每日扫描，及时响应
- **持仓周期**：平均持仓1-3个月
- **调仓时机**：共振信号变化时及时调整

## 实现架构

### 🏗️ 系统架构
```
多趋势共振策略
├── 数据层
│   ├── TuShare数据接口
│   ├── MongoDB数据存储
│   └── 多时间周期数据处理
├── 策略层
│   ├── 多趋势分析模块
│   ├── 技术指标计算模块
│   ├── 共振信号生成模块
│   └── 风险控制模块
├── 回测层
│   ├── 历史数据回测
│   ├── 绩效指标计算
│   └── 基准对比分析
└── 展示层
    ├── 策略报告生成
    ├── 技术分析图表
    └── 信号监控面板
```

### 📁 文件结构
```
quantitative/strategies/multi_trend_resonance_strategy.py     # 策略主文件
quantitative/test_multi_trend_resonance.py                  # 测试文件
quantitative/docs/多趋势共振策略.md                          # 策略文档
```

## 技术指标详解

### 📊 MACD指标应用
```python
def calculate_macd_score(stock_data):
    """计算MACD指标得分"""
    prices = stock_data['close']
    
    # 计算MACD
    ema12 = prices.ewm(span=12).mean()
    ema26 = prices.ewm(span=26).mean()
    macd_line = ema12 - ema26
    macd_signal = macd_line.ewm(span=9).mean()
    macd_hist = macd_line - macd_signal
    
    score = 0
    
    # MACD金叉（2分）
    if (macd_line.iloc[-1] > macd_signal.iloc[-1] and 
        macd_line.iloc[-2] <= macd_signal.iloc[-2]):
        score += 2
    # MACD在零轴上方（1分）
    elif macd_line.iloc[-1] > 0:
        score += 1
    
    # MACD柱状图转正（1分）
    if (macd_hist.iloc[-1] > 0 and macd_hist.iloc[-2] <= 0):
        score += 1
    
    return min(score, 3)  # 最高3分
```

### 📈 KDJ指标应用
```python
def calculate_kdj_score(stock_data):
    """计算KDJ指标得分"""
    high = stock_data['high']
    low = stock_data['low']
    close = stock_data['close']
    
    # 计算KDJ
    lowest_low = low.rolling(window=9).min()
    highest_high = high.rolling(window=9).max()
    rsv = (close - lowest_low) / (highest_high - lowest_low) * 100
    
    k_values = rsv.ewm(alpha=1/3).mean()
    d_values = k_values.ewm(alpha=1/3).mean()
    j_values = 3 * k_values - 2 * d_values
    
    score = 0
    
    # KDJ金叉（2分）
    if (k_values.iloc[-1] > d_values.iloc[-1] and 
        k_values.iloc[-2] <= d_values.iloc[-2]):
        score += 2
    # KDJ超卖反弹（1分）
    elif k_values.iloc[-1] < 20 and k_values.iloc[-1] > k_values.iloc[-2]:
        score += 1
    
    # J值向上突破（1分）
    if j_values.iloc[-1] > j_values.iloc[-2]:
        score += 1
    
    return min(score, 3)  # 最高3分
```

## 历史表现

### 📊 预期表现指标
基于策略设计和技术分析原理，预期表现如下：

| 指标 | 预期范围 | 说明 |
|------|----------|------|
| **年化收益率** | 15-25% | 基于多趋势共振的稳健收益 |
| **夏普比率** | 1.5-2.5 | 良好的风险调整收益 |
| **最大回撤** | -8% ~ -15% | 严格止损控制回撤 |
| **胜率** | 55-70% | 多重过滤提高胜率 |
| **年交易次数** | 20-40次 | 中等频率交易 |

### 🏆 策略优势
1. **多维验证**：多时间周期和多技术指标验证
2. **信号质量高**：严格的共振得分筛选
3. **风险可控**：明确的止损止盈机制
4. **适应性强**：适用于不同市场环境

## 使用指南

### 🚀 快速开始
```bash
# 1. 进入策略目录
cd quantitative

# 2. 运行完整回测
python test_multi_trend_resonance.py

# 3. 查看结果
# 详细结果保存在 multi_trend_resonance_backtest_results_*.json
```

### ⚙️ 参数配置
```python
strategy_params = {
    'macd_fast': 12,               # MACD快线周期
    'macd_slow': 26,               # MACD慢线周期
    'macd_signal': 9,              # MACD信号线周期
    'kdj_period': 9,               # KDJ周期
    'kdj_overbought': 80,          # KDJ超买线
    'kdj_oversold': 20,            # KDJ超卖线
    'volume_ma_period': 15,        # 成交量均线周期
    'volume_surge_threshold': 1.3,  # 成交量放大阈值
    'trend_strength_threshold': 0.3, # 趋势强度阈值
    'min_resonance_score': 6,      # 最小共振得分
    'strong_resonance_score': 9,   # 强共振得分
    'stop_loss': 0.06,             # 止损比例
    'take_profit': 0.12,           # 止盈比例
    'max_position_ratio': 0.12     # 最大单股仓位
}
```

### 📈 自定义优化
- **调整共振阈值**：根据市场环境优化得分要求
- **修改技术参数**：优化MACD、KDJ等指标参数
- **优化止损止盈**：调整风险收益比
- **增加过滤条件**：添加基本面或市场情绪指标

## 策略优化建议

### 🎯 参数优化方向
1. **共振得分权重**：根据历史表现优化各指标权重
2. **时间周期配置**：可尝试不同的多时间周期组合
3. **止损止盈比例**：根据回测结果优化风险收益比
4. **仓位管理**：动态调整单股和总仓位限制

### 📊 增强功能
1. **机器学习优化**：使用ML优化共振得分模型
2. **市场环境适应**：根据市场状态调整策略参数
3. **行业轮动**：结合行业强弱进行选股
4. **情绪指标**：加入市场情绪和资金流向分析

### 🔄 实盘适配
1. **交易成本**：考虑实际手续费和冲击成本
2. **流动性管理**：确保足够的流动性支持
3. **风险监控**：实时监控组合风险指标
4. **信号延迟**：处理实盘交易的信号延迟问题

## 注意事项

### ⚠️ 风险提示
1. **技术分析局限性**：纯技术策略可能在特殊市场环境下失效
2. **过度优化风险**：避免过度拟合历史数据
3. **市场环境变化**：策略需要根据市场变化进行调整
4. **流动性风险**：部分中证A500成分股可能存在流动性问题

### 🔧 技术要求
- Python 3.8+
- MongoDB数据库
- TuShare数据源
- 充足的计算资源

### 📞 技术支持
- 策略实现：基于kk_stock量化平台
- 数据支持：TuShare专业版
- 回测引擎：自研增强回测系统
- 技术架构：微服务化设计

## 版本历史

### v1.0.0 (2025-01-17)
- ✅ 完成多趋势共振策略核心逻辑
- ✅ 实现多时间周期技术分析
- ✅ 集成中证A500选股机制
- ✅ 完善共振得分计算模型
- ✅ 建立完整的测试框架

### 未来规划
- 🔄 策略代码调试优化
- 📊 历史回测数据验证
- 🤖 机器学习模型集成
- 📱 实时监控系统开发

---

**多趋势共振策略** - 多维技术分析，精准捕捉趋势共振，实现稳健投资收益！ 🎯

> 基于kk_stock量化平台 | 数据来源：TuShare | 回测引擎：自研增强版 | 股票池：中证A500成分股