# 小市值动量策略（太上老君3号策略）

## 策略概述

小市值动量策略是一个基于中证1000成分股的3因子增强量化策略，专注于挖掘小市值股票的成长潜力。该策略集成了RSI择时、多因子评分和全面风险控制三大核心要素，通过周度调仓机制实现稳健的超额收益。

### 🎯 策略定位
- **代号**: 太上老君3号策略
- **类型**: 小市值动量增强策略
- **基础**: 3因子策略思想优化
- **特色**: 每周调仓，降低交易成本

## 策略特色

### 🎯 核心理念
- **3因子增强**：RSI择时 + 多因子评分 + 风险控制
- **市场择时**：RSI(8日周期)判断市场时机
- **精准选股**：多因子评分排序，归一化处理
- **周度调仓**：每5个交易日调仓一次，降低交易成本
- **全面风控**：行业分散、止损止盈、紧急止损三重保护

### 📊 策略表现（基于回测）
- **年化收益率**：目标15-25%
- **夏普比率**：目标1.0-1.5
- **最大回撤**：目标控制在18-30%
- **胜率**：目标60-70%
- **调仓频率**：每周调仓（约每5个交易日）
- **持仓股数**：10-25只分散配置

## 策略逻辑

### 🔍 股票池构建
```python
# 1. 基础股票池：中证1000成分股
def get_small_cap_stocks(max_count=30):
    # 从DynamicStockPoolManager获取小市值股票
    pool_manager = DynamicStockPoolManager()
    selected_stocks = pool_manager.get_small_cap_stocks(max_count=max_count)
    
    # 基础筛选条件
    filter_criteria = {
        'min_market_cap': 100000.0,    # 最小市值10亿
        'max_market_cap': 1000000.0,   # 最大市值1000亿
        'exclude_st': True,            # 排除ST股票
        'exclude_suspended': True,     # 排除停牌股票
        'min_volume_ratio': 0.8,       # 最小量比要求
        'min_turnover_rate': 1.0,      # 最小换手率1%
        'max_turnover_rate': 12.0      # 最大换手率12%
    }
    
    return selected_stocks

# 2. 动态评分排序
def rank_stocks_by_score(stocks):
    # 计算每只股票的综合评分
    # 返回评分排序后的股票列表
    scores = []
    for stock in stocks:
        score = calculate_comprehensive_score(stock)
        scores.append((stock, score))
    
    # 按分数降序排序
    return sorted(scores, key=lambda x: x[1], reverse=True)
```

### 📈 3因子增强评分模型
```python
# 1. RSI市场择时模块
class MarketTimingModule:
    def __init__(self):
        self.rsi_period = 8      # RSI周期（周线）
        self.rsi_upper = 70      # RSI上限
        self.rsi_lower = 30      # RSI下限
        
    def get_market_signal(self, market_data):
        # 计算市场RSI
        rsi = calculate_rsi(market_data, self.rsi_period)
        
        if rsi >= self.rsi_upper:
            return -1  # 买入债券/降仓
        elif rsi <= self.rsi_lower:
            return 1   # 买入股票
        else:
            return 0   # 中性

# 2. 多因子评分系统
def calculate_comprehensive_score(stock_data):
    scores = {}
    
    # 技术因子
    scores['rsi_score'] = calculate_rsi_factor(stock_data)
    scores['macd_score'] = calculate_macd_factor(stock_data)
    scores['volume_factor'] = calculate_volume_factor(stock_data)
    
    # 基本面因子
    scores['pe_score'] = calculate_pe_factor(stock_data)
    scores['pb_score'] = calculate_pb_factor(stock_data)
    
    # 动量因子
    scores['momentum_score'] = calculate_momentum_factor(stock_data)
    
    # 归一化处理
    normalized_scores = {}
    for factor, score in scores.items():
        normalized_scores[factor] = normalize_score(score)
    
    # 综合评分
    total_score = sum(normalized_scores.values()) / len(normalized_scores)
    
    return min(max(total_score, 0), 1)  # 限制在[0,1]区间

# 3. 风险控制模块
def apply_risk_filters(stock_data, score):
    # 行业集中度检查
    if check_industry_concentration_risk(stock_data):
        score *= 0.8  # 降低评分
    
    # 流动性风险检查
    if not check_liquidity_risk(stock_data):
        return 0  # 直接排除
    
    # 财务风险检查
    if check_financial_risk(stock_data):
        score *= 0.9  # 降低评分
    
    return score
```

### 🚀 买入信号生成
基于3因子增强模型，满足以下**所有条件**时产生买入信号：

1. **择时信号**：RSI市场择时为正
2. **综合评分**：多因子综合评分≥0.6
3. **调仓时机**：周度调仓日
4. **风险控制**：通过各项风险检查

```python
def generate_buy_signals(self, current_date):
    signals = []
    
    # 1. 检查是否为调仓日
    if not self._should_rebalance(current_date):
        return signals  # 非调仓日不产生买入信号
    
    # 2. 获取市场择时信号
    market_signal = self.get_market_timing_signal(current_date)
    if market_signal <= 0:
        return signals  # 市场择时不利，不买入
    
    # 3. 对候选股票进行评分
    candidate_scores = []
    for stock_code in self.candidate_stocks:
        try:
            stock_data = self.get_stock_data(stock_code, current_date)
            score = self.calculate_comprehensive_score(stock_data)
            
            # 应用风险过滤
            if self.pass_risk_filters(stock_code, stock_data):
                candidate_scores.append((stock_code, score))
        except Exception as e:
            continue
    
    # 4. 按评分排序并选择前N只
    candidate_scores.sort(key=lambda x: x[1], reverse=True)
    
    # 5. 生成买入信号
    for stock_code, score in candidate_scores[:self.max_positions]:
        if score >= self.min_total_score:  # 0.6
            # 根据市场信号调整仓位
            position_ratio = self.stock_ratio_bullish if market_signal > 0 else self.stock_ratio_bearish
            
            signal = TradeSignal(
                symbol=stock_code,
                timestamp=current_date,
                signal_type='buy',
                price=self.get_current_price(stock_code),
                volume=self.calculate_position_size(stock_code, position_ratio),
                reason=f'3因子增强小盘策略(得分:{score:.3f}): 择时信号x{position_ratio}'
            )
            signals.append(signal)
    
    return signals
```

### 📉 卖出信号生成
分为两类卖出信号：**调仓日卖出**和**紧急止损卖出**

#### 调仓日卖出条件（任一满足）：
1. **评分下降**：综合评分跌破阈值
2. **择时转向**：市场择时信号转为熊市
3. **排名下降**：不再位于前N只股票

#### 紧急止损条件（任一满足）：
1. **止损保护**：跌破止损位(-6%)
2. **技术异常**：RSI极端值或换手率异常
3. **止盈保护**：达到止盈位(+15%)后回撤

```python
def generate_sell_signals(self, current_date):
    signals = []
    
    # 1. 检查调仓日卖出
    if self._should_rebalance(current_date):
        # 重新评分，卖出排名靠后的股票
        signals.extend(self._generate_rebalance_sell_signals(current_date))
    
    # 2. 检查紧急止损（每日检查）
    signals.extend(self._generate_emergency_sell_signals(current_date))
    
    return signals

def _generate_emergency_sell_signals(self, current_date):
    signals = []
    
    for stock_code in self.positions.keys():
        if self.get_current_position(stock_code) <= 0:
            continue
            
        try:
            stock_data = self.get_stock_data(stock_code, current_date)
            emergency_signal = self._check_emergency_sell(stock_code, stock_data, current_date)
            
            if emergency_signal:
                signals.append(emergency_signal)
        except Exception as e:
            continue
    
    return signals

def _check_emergency_sell(self, stock_code, stock_data, current_date):
    current_price = stock_data['close']
    
    # 1. 止损检查
    if self.check_stop_loss(stock_code, current_price):
        return self.create_sell_signal(stock_code, current_price, "止损保护")
    
    # 2. 止盈检查
    if self.check_take_profit(stock_code, current_price):
        return self.create_sell_signal(stock_code, current_price, "止盈保护")
    
    # 3. 技术异常检查
    rsi = stock_data.get('rsi_6', 50)
    if rsi > 90:
        return self.create_sell_signal(stock_code, current_price, f"紧急止损: RSI极端值({rsi:.1f})")
    
    # 4. 换手率异常检查
    turnover = stock_data.get('turnover_rate', 0)
    if turnover > 20:  # 换手率超过20%
        return self.create_sell_signal(stock_code, current_price, f"紧急止损: 换手率异常({turnover:.2f}%)")
    
    return None
```

## 风险管理

### 💰 资金管理（3因子增强配置）
- **初始资金**：100万元
- **单股限额**：最大4万元（4%仓位）
- **单股最大权重**：8%（风险控制）
- **总持仓数**：10-25只股票（高度分散）
- **调仓频率**：每5个交易日（约每周）
- **择时仓位**：牛市80%，熊市20%股票配置

### 🛡️ 风险控制（三重保护）
- **止损机制**：单股-6%止损，+15%止盈
- **行业分散**：单行业最大权重30%
- **仓位控制**：单股最大4%，避免过度集中
- **紧急止损**：RSI>90或换手率>20%时紧急卖出
- **市场择时**：RSI(8日)判断市场环境，动态调整仓位
- **质量筛选**：市值区间100亿-1000亿，避免微盘股风险

### ⏰ 时间管理（周度调仓）
- **调仓频率**：每5个交易日调仓一次
- **调仓判断**：`_should_rebalance()`方法控制
- **非调仓日**：仅执行紧急止损，不产生买入信号
- **持仓周期**：平均持仓1-2个月
- **成本控制**：降低交易频率，减少交易成本

## 实现架构

### 🏗️ 系统架构
```
小市值动量策略
├── 数据层
│   ├── TuShare数据接口
│   ├── MongoDB数据存储
│   └── 因子数据计算
├── 策略层
│   ├── 多因子评分模块
│   ├── 信号生成模块
│   └── 风险控制模块
├── 回测层
│   ├── 历史数据回测
│   ├── 绩效指标计算
│   └── 基准对比分析
└── 展示层
    ├── 策略报告生成
    ├── 因子分析图表
    └── 持仓监控面板
```

### 📁 文件结构
```
quantitative/strategies/small_cap_momentum_strategy.py     # 策略主文件
quantitative/test_small_cap_only.py                      # 测试文件
quantitative/core/dynamic_stock_pool_manager.py          # 动态选股管理
quantitative/docs/小市值动量策略.md                       # 策略文档
```

## 历史表现

### 📊 预期表现（基于3因子增强设计）

#### 目标表现指标
| 指标 | 目标范围 | 备注 |
|------|----------|------|
| 年化收益率 | 15-25% | 基于小市值成长股特性 |
| 夏普比率 | 1.0-1.5 | 风险调整后收益 |
| 最大回撤 | 18-30% | 小市值股票波动性 |
| 胜率 | 60-70% | 多因子筛选提升胜率 |
| 调仓次数 | 20-30次/年 | 每周调仓 |
| 持仓股数 | 10-25只 | 分散化配置 |

#### 与基准对比预期
- **vs 沪深300**: 预期超额收益10-20%
- **vs 中证500**: 预期超额收益5-15%
- **vs 中证1000**: 预期超额收益3-8%
- **vs 创业板指**: 预期超额收益8-18%

### 🏆 核心优势（3因子增强版）
1. **全面风控**：三重保护机制，行业分散，动态止损
2. **择时优化**：RSI市场择时，牛熊市仓位动态调整
3. **成本控制**：周度调仓，降低交易成本和滑点影响
4. **多因子选股**：综合技术、基本面、动量多维度评分
5. **小盘成长**：专注小市值股票，挖掘成长潜力
6. **系统性强**：规则化交易，减少主观判断误差

## 技术实现

### 🔧 核心类结构（3因子增强版）
```python
class SmallCapMomentumStrategy(BaseStrategy):
    """小市值动量策略 - 基于3因子策略思想优化"""
    
    def __init__(self, config: SmallCapMomentumConfig):
        super().__init__(config)
        
        # 3因子增强参数
        self.position_size = 0.04           # 单股最大仓位4%
        self.max_single_stock = 0.08        # 单股最大权重8%
        self.stop_loss = 0.06               # 止损6%
        self.take_profit = 0.15             # 止盈15%
        self.rebalance_frequency = 5        # 每5个交易日调仓
        
        # 择时参数
        self.market_timing_enabled = True   # 启用市场择时
        self.rsi_period = 8                 # RSI周期
        self.stock_ratio_bullish = 0.8      # 牛市股票比例
        self.stock_ratio_bearish = 0.2      # 熊市股票比例
        
        # 风险控制参数
        self.max_industry_weight = 0.3      # 单行业最大权重30%
        self.min_total_score = 0.6          # 最低总分要求
        
    def generate_signals(self, current_date) -> List[TradeSignal]:
        """生成交易信号（支持组合策略）"""
        if hasattr(self, 'stocks_data') and self.stocks_data:
            return self._generate_portfolio_signals(current_date)
        else:
            return self._generate_single_stock_signals(current_date)
    
    def _should_rebalance(self, current_date: datetime) -> bool:
        """检查是否应该调仓"""
        if not hasattr(self, 'last_rebalance_date') or self.last_rebalance_date is None:
            return True
        
        # 计算距离上次调仓的工作日天数
        days_diff = (current_date - self.last_rebalance_date).days
        return days_diff >= self.rebalance_frequency
    
    def get_market_timing_signal(self, current_date: datetime) -> int:
        """获取市场择时信号"""
        # 基于RSI的市场择时判断
        # 返回值：1=买入股票，-1=买入债券/降仓，0=中性
        pass
```

### 📊 数据依赖
```python
# 主要数据表
- stock_factor_pro: 技术因子数据
  - close, high, low, open: 价格数据
  - vol, amount: 成交量数据
  - pe_ttm, pb, ps_ttm: 估值数据
  - rsi_*, macd_*, boll_*: 技术指标
  
- fina_indicator: 财务指标数据
  - roe, roa: 盈利能力指标
  - debt_to_assets: 负债率
  - revenue_yoy: 营收增长率
  
- index_weight: 指数成分股
  - index_code: '000852.SH' (中证1000)
  - con_code: 成分股代码
```

## 使用指南

### 🚀 快速开始
```bash
# 1. 进入策略目录
cd quantitative

# 2. 运行完整回测
python test_small_cap_only.py

# 3. 查看结果
# 详细结果保存在 small_cap_backtest_results_*.json
```

### ⚙️ 参数配置（3因子增强版）
```python
strategy_config = SmallCapMomentumConfig(
    symbol=selected_stocks[0],
    start_date=start_date,
    end_date=end_date,
    initial_capital=1000000.0,      # 100万资金
    
    # 3因子策略优化参数
    position_size=0.04,             # 单股最大仓位4%
    max_market_cap=1000000.0,       # 最大市值1000亿
    min_market_cap=100000.0,        # 最小市值100亿
    volume_ratio_min=0.8,           # 量比最低要求
    turnover_rate_min=1.0,          # 换手率最低要求1%
    turnover_rate_max=12.0,         # 换手率上限12%
    min_total_score=0.6,            # 最低总分要求
    strong_signal_score=0.8,        # 强信号分数阈值
    
    # 择时参数
    market_timing_enabled=True,     # 启用市场择时
    rsi_period=8,                   # RSI周期
    rsi_upper=70,                   # RSI上限
    rsi_lower=30,                   # RSI下限
    stock_ratio_bullish=0.8,        # 牛市股票比例
    stock_ratio_bearish=0.2,        # 熊市股票比例
    
    # 风险控制参数
    max_industry_weight=0.3,        # 单行业最大权重30%
    max_single_stock=0.08,          # 单股最大权重8%
    stop_loss=0.06,                 # 止损6%
    take_profit=0.15                # 止盈15%
)
```

### 📈 自定义优化
- **调整因子权重**：根据市场环境优化因子配置
- **修改选股数量**：平衡分散度和选择性
- **优化止损策略**：提高风险控制效果
- **增加行业过滤**：控制行业集中度风险

## 策略优化建议

### 🎯 参数优化方向
1. **因子权重**：根据市场环境动态调整
2. **持仓数量**：可调整5-15只股票
3. **调仓频率**：可尝试双周或月度调仓
4. **止损策略**：可引入动态止损机制

### 📊 增强功能
1. **行业轮动**：结合行业景气度分析
2. **宏观择时**：加入宏观经济指标
3. **情绪指标**：结合市场情绪数据
4. **机器学习**：使用ML优化因子权重

### 🔄 实盘适配
1. **交易成本**：考虑实际手续费和冲击成本
2. **流动性管理**：避免流动性不足的股票
3. **风险监控**：实时监控组合风险指标
4. **资金管理**：动态调整仓位大小

## 注意事项

### ⚠️ 风险提示
1. **小市值风险**：小市值股票波动较大
2. **流动性风险**：部分股票可能流动性不足
3. **集中度风险**：避免过度集中于某个行业
4. **市场风险**：系统性风险无法完全规避

### 🔧 技术要求
- Python 3.8+
- MongoDB数据库
- TuShare数据源
- 充足的计算资源

### 📞 技术支持
- 策略实现：基于kk_stock量化平台
- 数据支持：TuShare专业版
- 回测引擎：自研增强回测系统
- 技术架构：微服务化设计

## 版本历史

### v2.0.0 (2025-01-17) - 3因子增强版
- ✅ 集成3因子策略思想（RSI择时+多因子评分+风险控制）
- ✅ 实现周度调仓机制，降低交易成本
- ✅ 增加市场择时模块，动态调整仓位
- ✅ 完善风险控制：行业分散、紧急止损、动态止盈
- ✅ 优化持仓结构：单股4%仓位，最大25只股票
- ✅ 修复类型错误，确保策略稳定运行

### 未来规划
- 🔄 实盘交易接口对接
- 📊 因子有效性分析工具
- 🤖 机器学习因子优化
- 📱 移动端监控应用

---

**太上老君3号策略（小市值动量3因子增强版）** - 择时+选股+风控，三位一体的专业量化解决方案！ 🎯

> 基于kk_stock量化平台 | 数据来源：TuShare | 回测引擎：自研增强版 | 股票池：中证1000成分股 | 3因子策略思想优化